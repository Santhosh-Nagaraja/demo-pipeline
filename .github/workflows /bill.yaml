# This is a basic workflow to help you get started with Actions

name: Billing-App

# Controls when the workflow will run
on:
  pull_request:
    types: [closed]
    branches:
      - release

  push:
    branches:
      - release

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    
env:
  image_version: ${{ github.run_number }}

jobs:
  push_image_new_cloud_run_create:
    if: github.actor == 'Santhosh-Nagaraja' && github.event.pull_request.merged == true # Run this job only if a pull request is merged
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 1.6.6   # Specify the desired Terraform version

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validation
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -var="image_tag=${{ env.image_version }}"

      - name: Terraform Apply
        run: terraform apply -auto-approve -var image_tag=${image_version}

  push_image_cloud_run_configure_docker_image:
    if: github.actor == 'Santhosh-Nagaraja' && github.event_name == 'push' && !contains(github.event.head_commit.message, '[ci skip]') # Run job on push events excluding specific commit messages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 1.6.6   # Specify the desired Terraform version

      - name: Terraform Init
        working-directory: ./client-folder
        run: terraform init
      
      - name: Terraform Format
        working-directory: ./client-folder
        run: terraform fmt
         
      - name: Terraform Validation
        working-directory: ./client-folder
        run: terraform validate

      - name: Terraform Plan
        working-directory: ./client-folder
        run: terraform plan

      - name: Terraform Apply
        working-directory: ./client-folder
        run: terraform apply --auto-approve 
